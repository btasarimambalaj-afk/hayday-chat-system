<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HayDay Destek - Canlı Chat">
    <title>HayDay Destek</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="chat-popup-body">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status" style="display: none;">
        🔄 Bağlantı kuruluyor...
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">
                    🌾
                </div>

                <div class="chat-title">
                    <h3>HayDay Destek</h3>
                    <div class="chat-status">Çevrimiçi</div>
                </div>

            </div>

            <div class="chat-header-actions">
                <button class="chat-search-btn" id="searchBtn" aria-label="Arama">
                    🔍
                </button>
                <button class="chat-close-btn" id="closeBtn" aria-label="Kapat">
                    ✕
                </button>
            </div>

        </div>

        <!-- Search Bar -->
        <div class="chat-search" id="searchBar" style="display: none;">
            <input type="text" class="search-input" id="searchInput" placeholder="Mesajlarda ara..." maxlength="100">
            <button class="search-clear-btn" id="searchClear">✕</button>
        </div>


        <!-- Quick Actions -->
        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" data-message="Merhaba">
                👋 Merhaba
            </button>
            <button class="quick-action-btn" data-message="Altın transferi hakkında bilgi">
                💰 Altın Transferi
            </button>
            <button class="quick-action-btn" data-message="Ürün fiyatları nedir?">
                💸 Fiyat Listesi
            </button>
            <button class="quick-action-btn" data-message="Depolama hesaplama">
                📦 Depolama
            </button>
        </div>


        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
        
            <!-- Welcome Message -->
            <div class="chat-welcome" id="welcomeMessage">
            
                <div class="welcome-avatar">
                    🌾
                </div>

                <h4>HayDay Destek'e Hoş Geldiniz!</h4>

                <p>Size nasıl yardımcı olabilirim? HayDay oyunu ve sitemizdeki hizmetler hakkında sorularınızı sorabilirsiniz.</p>

            </div>

        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-avatar">
                🤖
            </div>

            <div class="typing-text">
                HayDay Bot yazıyor...
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

        </div>


        <!-- Input Area -->
        <div class="chat-input-container">
        
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Mesajınızı yazın..." 
                    rows="1" 
                    maxlength="1000"
                ></textarea>
                
                <button class="send-button" id="sendButton" disabled>
                    <span class="send-icon">→</span>
                </button>
            </div>

            <div class="chat-input-footer">
                <span class="powered-by">HayDay Malzemeleri tarafından desteklenmektedir</span>
                <span class="char-count" id="charCount">0/1000</span>
            </div>

        </div>
    </div>

    <!-- Footer Actions -->
    <div class="chat-footer-actions">
        <a href="login.html" class="footer-link" id="adminLink">
            👑👑👑
            Admin
        </a>
    </div>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script>
        /**
         * 🌾 HayDay Chat System - Main Chat Interface
         */

        class HayDayChat {
            constructor() {
                this.clientId = this.getOrCreateClientId();
                this.messages = [];
                this.lastMessageTimestamp = 0;
                this.isConnected = false;
                this.pollInterval = null;
                this.searchMode = false;
                this.typingTimeout = null;
                
                this.init();
            }

            getOrCreateClientId() {
                let clientId = localStorage.getItem('hayday_client_id');
                if (!clientId) {
                    clientId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('hayday_client_id', clientId);
                }
                return clientId;
            }

            init() {
                console.log('🌾 HayDay Chat initializing...', this.clientId);
                
                this.bindEvents();
                this.setupAutoResize();
                this.loadHistory();
                this.startPolling();
                this.showConnectionStatus('connecting');
                
                // Show quick actions initially
                document.getElementById('quickActions').classList.add('show');
            }

            bindEvents() {
                const elements = {
                    sendButton: document.getElementById('sendButton'),
                    messageInput: document.getElementById('messageInput'),
                    searchBtn: document.getElementById('searchBtn'),
                    closeBtn: document.getElementById('closeBtn'),
                    searchInput: document.getElementById('searchInput'),
                    searchClear: document.getElementById('searchClear'),
                    charCount: document.getElementById('charCount')
                };

                // Send message
                elements.sendButton.addEventListener('click', () => this.sendMessage());
                
                // Enter to send
                elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Input handling
                elements.messageInput.addEventListener('input', (e) => {
                    this.handleInputChange(e.target.value);
                });

                // Search functionality
                elements.searchBtn.addEventListener('click', () => this.toggleSearch());
                elements.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                elements.searchClear.addEventListener('click', () => this.clearSearch());

                // Close button
                elements.closeBtn.addEventListener('click', () => {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage('close-chat', '*');
                    }
                });

                // Quick actions
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const message = btn.dataset.message;
                        elements.messageInput.value = message;
                        this.handleInputChange(message);
                        elements.messageInput.focus();
                    });
                });

                // Escape key handling
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (this.searchMode) {
                            this.toggleSearch();
                        }
                    }
                });
            }

            setupAutoResize() {
                const messageInput = document.getElementById('messageInput');
                
                messageInput.addEventListener('input', () => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                });
            }

            handleInputChange(value) {
                const sendButton = document.getElementById('sendButton');
                const charCount = document.getElementById('charCount');
                
                // Update character count
                charCount.textContent = `${value.length}/1000`;
                
                // Enable/disable send button
                sendButton.disabled = !value.trim() || value.length > 1000;
                
                // Update button style
                if (value.trim() && value.length <= 1000) {
                    sendButton.style.background = '#4CAF50';
                } else {
                    sendButton.style.background = '#757575';
                }
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message || message.length > 1000) return;

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                this.handleInputChange('');

                // Add user message to UI
                this.addMessage({
                    timestamp: Date.now(),
                    clientId: this.clientId,
                    role: 'user',
                    content: message
                });

                // Show typing indicator
                this.showTyping();

                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            clientId: this.clientId,
                            message: message
                        })
                    });

                    const data = await response.json();
                    
                    // Hide typing indicator
                    this.hideTyping();

                    if (response.ok) {
                        // Add bot response
                        this.addMessage({
                            timestamp: data.timestamp || Date.now(),
                            clientId: this.clientId,
                            role: data.role || 'bot',
                            content: data.reply,
                            confidence: data.confidence
                        });

                        this.showConnectionStatus('connected');
                    } else {
                        throw new Error(data.error || 'Mesaj gönderilemedi');
                    }

                } catch (error) {
                    console.error('Send message error:', error);
                    this.hideTyping();
                    
                    // Show error message
                    this.addMessage({
                        timestamp: Date.now(),
                        clientId: this.clientId,
                        role: 'system',
                        content: 'Üzgünüm, bir hata oluştu. Lütfen Sorular & İletişim sayfamızdan bize ulaşın.'
                    });

                    this.showConnectionStatus('error');
                }
            }

            addMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                // Hide welcome message
                if (welcomeMessage) {
                    welcomeMessage.style.display = 'none';
                }

                // Hide quick actions after first message
                document.getElementById('quickActions').classList.remove('show');

                // Create message element
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${message.role}`;
                messageEl.dataset.timestamp = message.timestamp;

                const avatar = this.getRoleAvatar(message.role);
                const badge = this.getRoleBadge(message.role);
                const time = HayDayChat.Utils.formatTime(message.timestamp);

                messageEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar" style="background: ${this.getRoleColor(message.role)}">
                            ${avatar}
                        </div>
                        <div class="message-info">
                            <span class="message-sender">${this.getRoleName(message.role)}</span>
                            <span class="message-badge badge-${message.role}">${badge}</span>
                            <span class="message-time">${time}</span>
                        </div>
                    </div>
                    <div class="message-content">
                        ${this.formatMessageContent(message.content)}
                    </div>
                `;

                messagesContainer.appendChild(messageEl);
                this.scrollToBottom();

                // Store message
                this.messages.push(message);
                this.lastMessageTimestamp = Math.max(this.lastMessageTimestamp, message.timestamp);

                // Store in localStorage
                localStorage.setItem('hayday_messages', JSON.stringify(this.messages.slice(-50))); // Keep last 50 messages
            }

            formatMessageContent(content) {
                // Sanitize and format content
                let formatted = HayDayChat.Utils.sanitizeHtml(content);
                formatted = HayDayChat.Utils.linkify(formatted);
                formatted = HayDayChat.Utils.emojify(formatted);
                return formatted;
            }

            getRoleAvatar(role) {
                const avatars = {
                    user: '👤',
                    bot: '🤖',
                    chatbot: '🤖',
                    ai: '🧠',
                    admin: '👑',
                    system: '⚙️'
                };
                return avatars[role] || '💬';
            }

            getRoleBadge(role) {
                const badges = {
                    user: 'Sen',
                    bot: 'Bot',
                    chatbot: 'Bot',
                    ai: 'AI',
                    admin: 'Admin',
                    system: 'Sistem'
                };
                return badges[role] || 'Bot';
            }

            getRoleName(role) {
                const names = {
                    user: 'Sen',
                    bot: 'HayDay Bot',
                    chatbot: 'HayDay Bot',
                    ai: 'HayDay AI',
                    admin: 'HayDay Admin',
                    system: 'Sistem'
                };
                return names[role] || 'HayDay Bot';
            }

            getRoleColor(role) {
                const colors = {
                    user: '#757575',
                    bot: '#4CAF50',
                    chatbot: '#4CAF50',
                    ai: '#9C27B0',
                    admin: '#1B5E20',
                    system: '#FF9800'
                };
                return colors[role] || '#4CAF50';
            }

            showTyping() {
                const typingIndicator = document.getElementById('typingIndicator');
                typingIndicator.style.display = 'flex';
                this.scrollToBottom();
            }

            hideTyping() {
                const typingIndicator = document.getElementById('typingIndicator');
                typingIndicator.style.display = 'none';
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                HayDayChat.Animations.scrollTo(messagesContainer);
            }

            async loadHistory() {
                try {
                    // Load from localStorage first
                    const savedMessages = localStorage.getItem('hayday_messages');
                    if (savedMessages) {
                        const messages = JSON.parse(savedMessages);
                        messages.forEach(message => this.addMessage(message));
                    }

                    // Load from server
                    const response = await fetch(`/api/chat/history/${this.clientId}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Process server history if needed
                    }
                } catch (error) {
                    console.error('Load history error:', error);
                }
            }

            startPolling() {
                this.pollInterval = setInterval(() => {
                    this.pollNewMessages();
                }, 5000); // Poll every 5 seconds
            }

            async pollNewMessages() {
                try {
                    const response = await fetch(`/api/chat/poll/${this.clientId}?after=${this.lastMessageTimestamp}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.newMessages && data.newMessages.length > 0) {
                            data.newMessages.forEach(message => {
                                // Only add messages that aren't from this user
                                if (message.role !== 'user') {
                                    this.addMessage(message);
                                }
                            });
                        }

                        this.lastMessageTimestamp = data.lastTimestamp || this.lastMessageTimestamp;
                        this.showConnectionStatus('connected');
                    } else {
                        this.showConnectionStatus('error');
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    this.showConnectionStatus('error');
                }
            }

            showConnectionStatus(status) {
                const statusEl = document.getElementById('connectionStatus');
                const messages = {
                    connecting: '🔄 Bağlantı kuruluyor...',
                    connected: '✅ Bağlandı',
                    error: '❌ Bağlantı hatası'
                };

                statusEl.textContent = messages[status];
                statusEl.className = `connection-status ${status}`;
                statusEl.style.display = 'block';

                if (status === 'connected') {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 2000);
                }

                this.isConnected = status === 'connected';
            }

            toggleSearch() {
                const searchBar = document.getElementById('searchBar');
                const searchInput = document.getElementById('searchInput');
                
                this.searchMode = !this.searchMode;
                
                if (this.searchMode) {
                    searchBar.style.display = 'flex';
                    searchInput.focus();
                } else {
                    searchBar.style.display = 'none';
                    this.clearSearch();
                }
            }

            handleSearch(query) {
                const messages = document.querySelectorAll('.message');
                
                messages.forEach(messageEl => {
                    const content = messageEl.querySelector('.message-content').textContent;
                    const isMatch = !query || HayDayChat.Search.fuzzyMatch(content, query);
                    
                    if (isMatch) {
                        messageEl.style.display = 'block';
                        if (query) {
                            const contentEl = messageEl.querySelector('.message-content');
                            contentEl.innerHTML = HayDayChat.Search.highlight(contentEl.textContent, query);
                        }
                    } else {
                        messageEl.style.display = 'none';
                    }
                });
            }

            clearSearch() {
                const searchInput = document.getElementById('searchInput');
                searchInput.value = '';
                this.handleSearch('');
            }
        }

        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.haydayChat = new HayDayChat();
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (window.haydayChat && window.haydayChat.pollInterval) {
                clearInterval(window.haydayChat.pollInterval);
            }
        });
    </script>
</body>
</html>
