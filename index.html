<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HayDay Chat Destek</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional specific styles for main chat */
        .admin-link {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--admin-green);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .admin-link:hover {
            opacity: 1;
        }

        /* Chat container adjustments for full page */
        .chat-container {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
        }

        /* Enhanced message styles */
        .message-content a {
            color: var(--primary);
            font-weight: 500;
        }

        .message-content .highlight {
            background: rgba(76, 175, 80, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* Connection status styling */
        .connection-status.connecting {
            background: var(--warning);
        }

        .connection-status.connected {
            background: var(--success);
        }

        .connection-status.error {
            background: var(--danger);
        }

        /* Quick actions */
        .quick-actions {
            padding: 16px;
            background: var(--surface-dark);
            border-bottom: 1px solid var(--border);
            display: none;
        }

        .quick-actions.show {
            display: block;
        }

        .quick-action-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            margin: 4px 8px 4px 0;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Enhanced typing indicator */
        .typing-indicator {
            margin: 16px;
        }

        .typing-role {
            font-weight: 600;
            color: var(--primary);
        }

        /* Message timestamps */
        .message-time {
            cursor: help;
        }

        /* Status indicators */
        .chat-status.online { color: var(--success); }
        .chat-status.busy { color: var(--warning); }
        .chat-status.away { color: var(--text-secondary); }
    </style>
</head>
<body class="chat-popup-body">
    <!-- Connection Status -->
    <div id="connection-status" class="connection-status connecting">
        <span>⚠️</span>
        Bağlantı kuruluyor...
    </div>

    <!-- Main Chat Container -->
    <div class="chat-container">
        <!-- Chat Header -->
        <header class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">🤖</div>
                <div class="chat-title">
                    <h3>HayDay Destek</h3>
                    <div class="chat-status online" id="chat-status">Çevrimiçi</div>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-search-btn" onclick="toggleSearch()" title="Arama">
                    <span>🔍</span>
                </button>
                <button class="chat-close-btn" onclick="closeChat()" title="Kapat">
                    <span>✕</span>
                </button>
            </div>
        </header>

        <!-- Search Bar (hidden by default) -->
        <div class="chat-search" id="chat-search" style="display: none;">
            <input type="text" class="search-input" placeholder="Mesajlarda ara..." 
                   onkeyup="searchMessages(this.value)">
            <button class="search-clear-btn" onclick="clearSearch()" title="Temizle">
                <span>✕</span>
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" id="quick-actions">
            <button class="quick-action-btn" onclick="sendQuickMessage('Merhaba!')">
                <span>👋</span> Merhaba
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Altın transferi nasıl yapılır?')">
                <span>💰</span> Altın Transferi
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Fiyat listesi görebilir miyim?')">
                <span>📋</span> Fiyat Listesi
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Depolama hesaplama')">
                <span>📦</span> Depolama
            </button>
        </div>

        <!-- Messages Area -->
        <main class="chat-messages" id="chat-messages">
            <!-- Welcome Message -->
            <div class="chat-welcome">
                <div class="welcome-avatar">🤖</div>
                <h4>HayDay Destek'e Hoş Geldiniz!</h4>
                <p>Size nasıl yardımcı olabilirim? HayDay oyunu ve sitemizdeki hizmetler hakkında sorularınızı sorabilirsiniz.</p>
            </div>
        </main>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            <div class="typing-avatar">🤖</div>
            <div class="typing-text">
                <span class="typing-role">HayDay Bot</span> yazıyor...
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <footer class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="message-input" 
                    placeholder="Mesajınızı yazın..."
                    rows="1"
                    maxlength="1000"
                    onkeypress="handleKeyPress(event)"
                    oninput="autoResize(this); updateCharCount()"
                ></textarea>
                <button class="send-button" id="send-button" onclick="sendMessage()" disabled>
                    <span class="send-icon">📤</span>
                </button>
            </div>
            <div class="chat-input-footer">
                <span class="powered-by">HayDay Malzemeleri tarafından desteklenmektedir</span>
                <span class="char-count" id="char-count">0/1000</span>
            </div>
        </footer>
    </div>

    <!-- Admin Panel Link -->
    <a href="login.html" class="admin-link" title="Admin Panel">
        <span>👨‍💼</span>
        Admin
    </a>

    <script src="script.js"></script>
    <script>
        // Enhanced chat functionality
        class HayDayChatSystem {
            constructor() {
                this.clientId = this.generateClientId();
                this.messages = [];
                this.isConnected = false;
                this.pollInterval = null;
                this.lastPollTimestamp = 0;
                this.searchActive = false;
                this.searchResults = [];
                
                this.init();
            }

            generateClientId() {
                // Try to get existing clientId from localStorage
                let clientId = localStorage.getItem('hayday_chat_client_id');
                if (!clientId) {
                    clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('hayday_chat_client_id', clientId);
                }
                return clientId;
            }

            async init() {
                this.updateConnectionStatus('connecting', 'Bağlantı kuruluyor...');
                
                // Load chat history
                await this.loadChatHistory();
                
                // Test connection
                await this.testConnection();
                
                // Start polling for new messages
                this.startPolling();
                
                // Setup UI handlers
                this.setupEventHandlers();
                
                // Show quick actions after 3 seconds if no messages
                setTimeout(() => {
                    if (this.messages.length === 0) {
                        this.showQuickActions();
                    }
                }, 3000);
            }

            async testConnection() {
                try {
                    const response = await fetch('/ping');
                    const data = await response.json();
                    
                    if (data.ok) {
                        this.isConnected = true;
                        this.updateConnectionStatus('connected', 'Bağlandı');
                        setTimeout(() => {
                            document.getElementById('connection-status').style.display = 'none';
                        }, 2000);
                    } else {
                        throw new Error('Server not responding properly');
                    }
                } catch (error) {
                    console.error('Connection test failed:', error);
                    this.isConnected = false;
                    this.updateConnectionStatus('error', 'Bağlantı hatası - Yeniden deniyor...');
                    
                    // Retry after 5 seconds
                    setTimeout(() => this.testConnection(), 5000);
                }
            }

            async loadChatHistory() {
                try {
                    const response = await fetch(`/api/chat/history/${this.clientId}`);
                    const data = await response.json();
                    
                    if (response.ok && data.history) {
                        this.messages = data.history;
                        this.renderMessages();
                        
                        if (this.messages.length > 0) {
                            this.lastPollTimestamp = Math.max(...this.messages.map(m => m.timestamp));
                        }
                    }
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                }
            }

            startPolling() {
                this.pollInterval = setInterval(() => {
                    if (this.isConnected) {
                        this.pollNewMessages();
                    }
                }, 2000); // Poll every 2 seconds
            }

            async pollNewMessages() {
                try {
                    const response = await fetch(`/api/chat/poll/${this.clientId}?after=${this.lastPollTimestamp}`);
                    const data = await response.json();
                    
                    if (response.ok && data.newMessages && data.newMessages.length > 0) {
                        // Add new messages
                        for (const message of data.newMessages) {
                            if (!this.messages.find(m => m.timestamp === message.timestamp)) {
                                this.messages.push(message);
                            }
                        }
                        
                        this.renderMessages();
                        this.lastPollTimestamp = data.lastTimestamp;
                        
                        // Play notification sound for bot/ai/admin messages
                        const botMessages = data.newMessages.filter(m => m.role !== 'user');
                        if (botMessages.length > 0) {
                            this.playNotificationSound();
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }

            renderMessages() {
                const messagesContainer = document.getElementById('chat-messages');
                
                // Clear welcome message if we have messages
                if (this.messages.length > 0) {
                    messagesContainer.innerHTML = '';
                }
                
                // Render all messages
                this.messages.forEach((message, index) => {
                    const messageElement = this.createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                this.scrollToBottom();
            }

            createMessageElement(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${message.role}`;
                messageDiv.dataset.timestamp = message.timestamp;
                
                const roleConfig = {
                    user: { avatar: '👤', name: 'Siz', badge: 'KULLANICI' },
                    chatbot: { avatar: '🤖', name: 'HayDay Bot', badge: 'BOT' },
                    ai: { avatar: '🧠', name: 'Yapay Zeka', badge: 'AI' },
                    admin: { avatar: '👨‍💼', name: 'Destek Uzmanı', badge: 'UZMAN' },
                    system: { avatar: '⚙️', name: 'Sistem', badge: 'SISTEM' }
                };
                
                const config = roleConfig[message.role] || roleConfig.system;
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar">${config.avatar}</div>
                        <div class="message-info">
                            <span class="message-sender">${config.name}</span>
                            <span class="message-badge badge-${message.role}">${config.badge}</span>
                        </div>
                        <span class="message-time" title="${new Date(message.timestamp).toLocaleString('tr-TR')}">${this.formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${this.formatMessageContent(message.content)}</div>
                `;
                
                return messageDiv;
            }

            formatMessageContent(content) {
                // Convert URLs to links
                content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
                
                // Highlight page mentions
                const pageMapping = {
                    'Sorular & İletişim': 'sorular-iletisim',
                    'Ürün Listenizi Oluşturun': 'urun-listesi',
                    'Depolama Hesaplayıcısı': 'depolama-hesaplayici',
                    'Makineler': 'makineler'
                };
                
                for (const [pageName, pageSlug] of Object.entries(pageMapping)) {
                    const regex = new RegExp(`"(${pageName})"`, 'gi');
                    content = content.replace(regex, `"<span class="highlight">${pageName}</span>"`);
                }
                
                return content;
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / (1000 * 60));
                
                if (diffMinutes < 1) return 'Şimdi';
                if (diffMinutes < 60) return `${diffMinutes} dk`;
                if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)} sa`;
                return date.toLocaleDateString('tr-TR');
            }

            async sendMessage(content = null) {
                const messageInput = document.getElementById('message-input');
                const message = content || messageInput.value.trim();
                
                if (!message || !this.isConnected) return;
                
                // Add user message immediately
                const userMessage = {
                    timestamp: Date.now(),
                    clientId: this.clientId,
                    role: 'user',
                    content: message
                };
                
                this.messages.push(userMessage);
                this.renderMessages();
                
                // Clear input
                if (!content) {
                    messageInput.value = '';
                    this.updateCharCount();
                    this.autoResize(messageInput);
                }
                
                // Show typing indicator
                this.showTypingIndicator();
                
                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            clientId: this.clientId,
                            message: message
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Response will come through polling, but add it immediately for better UX
                        const botMessage = {
                            timestamp: data.timestamp || Date.now(),
                            clientId: this.clientId,
                            role: data.role,
                            content: data.reply,
                            confidence: data.confidence
                        };
                        
                        this.messages.push(botMessage);
                        this.renderMessages();
                        this.lastPollTimestamp = botMessage.timestamp;
                        
                        // Play notification sound
                        this.playNotificationSound();
                        
                        // Hide quick actions after first interaction
                        this.hideQuickActions();
                    } else {
                        throw new Error(data.error || 'Mesaj gönderilemedi');
                    }
                } catch (error) {
                    console.error('Send message error:', error);
                    
                    // Add error message
                    const errorMessage = {
                        timestamp: Date.now(),
                        clientId: this.clientId,
                        role: 'system',
                        content: 'Üzgünüm, mesajınız gönderilemedi. Lütfen tekrar deneyin.'
                    };
                    
                    this.messages.push(errorMessage);
                    this.renderMessages();
                } finally {
                    this.hideTypingIndicator();
                }
            }

            showTypingIndicator() {
                document.getElementById('typing-indicator').style.display = 'flex';
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                document.getElementById('typing-indicator').style.display = 'none';
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            updateConnectionStatus(status, message) {
                const statusElement = document.getElementById('connection-status');
                statusElement.className = `connection-status ${status}`;
                statusElement.innerHTML = `<span>${this.getStatusIcon(status)}</span> ${message}`;
                statusElement.style.display = 'flex';
            }

            getStatusIcon(status) {
                const icons = {
                    connecting: '🔄',
                    connected: '✅',
                    error: '❌'
                };
                return icons[status] || '⚠️';
            }

            playNotificationSound() {
                // Create and play a subtle notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            }

            showQuickActions() {
                document.getElementById('quick-actions').classList.add('show');
            }

            hideQuickActions() {
                document.getElementById('quick-actions').classList.remove('show');
            }

            setupEventHandlers() {
                const messageInput = document.getElementById('message-input');
                const sendButton = document.getElementById('send-button');
                
                // Enable send button when there's text
                messageInput.addEventListener('input', () => {
                    const hasText = messageInput.value.trim().length > 0;
                    sendButton.disabled = !hasText || !this.isConnected;
                });
                
                // Handle connection status changes
                window.addEventListener('online', () => {
                    this.testConnection();
                });
                
                window.addEventListener('offline', () => {
                    this.isConnected = false;
                    this.updateConnectionStatus('error', 'İnternet bağlantısı yok');
                });
                
                // Save state on page unload
                window.addEventListener('beforeunload', () => {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                    }
                });
            }

            // Search functionality
            searchMessages(query) {
                if (!query.trim()) {
                    this.clearSearch();
                    return;
                }
                
                const searchQuery = query.toLowerCase().trim();
                this.searchResults = this.messages.filter(message => 
                    message.content.toLowerCase().includes(searchQuery)
                );
                
                // Highlight search results
                const messageElements = document.querySelectorAll('.message');
                messageElements.forEach(element => {
                    const timestamp = element.dataset.timestamp;
                    const isMatch = this.searchResults.some(result => result.timestamp == timestamp);
                    
                    element.style.opacity = isMatch ? '1' : '0.3';
                });
                
                this.searchActive = true;
            }

            clearSearch() {
                this.searchActive = false;
                this.searchResults = [];
                
                // Reset opacity
                const messageElements = document.querySelectorAll('.message');
                messageElements.forEach(element => {
                    element.style.opacity = '1';
                });
                
                // Clear search input
                document.querySelector('.search-input').value = '';
            }
        }

        // Global functions for HTML onclick handlers
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                chatSystem.sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function updateCharCount() {
            const input = document.getElementById('message-input');
            const counter = document.getElementById('char-count');
            counter.textContent = `${input.value.length}/1000`;
        }

        function toggleSearch() {
            const searchBar = document.getElementById('chat-search');
            const isVisible = searchBar.style.display !== 'none';
            
            searchBar.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                searchBar.querySelector('.search-input').focus();
            } else {
                chatSystem.clearSearch();
            }
        }

        function clearSearch() {
            chatSystem.clearSearch();
        }

        function searchMessages(query) {
            chatSystem.searchMessages(query);
        }

        function sendQuickMessage(message) {
            chatSystem.sendMessage(message);
        }

        function sendMessage() {
            chatSystem.sendMessage();
        }

        function closeChat() {
            if (confirm('Chat penceresini kapatmak istediğinizden emin misiniz?')) {
                window.close();
            }
        }

        // Initialize chat system
        let chatSystem;
        document.addEventListener('DOMContentLoaded', function() {
            chatSystem = new HayDayChatSystem();
        });
    </script>
</body>
</html>
