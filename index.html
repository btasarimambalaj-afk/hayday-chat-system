<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HayDay Destek Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="chat-popup-body">
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">🤖</div>
                <div class="chat-title">
                    <h3>HayDay Destek</h3>
                    <span class="chat-status" id="chatStatus">Çevrimiçi</span>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-search-btn" id="searchBtn">🔍</button>
                <button class="chat-close-btn" id="closeBtn">✕</button>
            </div>
        </div>

        <!-- Search Bar (Hidden by default) -->
        <div class="chat-search" id="chatSearch" style="display: none;">
            <input type="text" id="searchInput" placeholder="Mesajlarda ara..." class="search-input">
            <button class="search-clear-btn" id="searchClear">✕</button>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <div class="chat-welcome">
                <div class="welcome-avatar">🤖</div>
                <h4>HayDay Destek'e Hoş Geldiniz!</h4>
                <p>Size nasıl yardımcı olabilirim? HayDay oyunu ve sitemizdeki hizmetler hakkında sorularınızı sorabilirsiniz.</p>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-avatar">🤖</div>
            <div class="typing-text">
                <span id="typingRole">HayDay Bot</span> yazıyor...
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="messageInput" 
                    placeholder="Mesajınızı yazın..." 
                    class="chat-input"
                    rows="1"
                    maxlength="1000"
                ></textarea>
                <button id="sendButton" class="send-button" disabled>
                    <span class="send-icon">📤</span>
                </button>
            </div>
            <div class="chat-input-footer">
                <span class="powered-by">HayDay Malzemeleri tarafından desteklenmektedir</span>
                <span class="char-count" id="charCount">0/1000</span>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus" style="display: none;">
        <span class="status-icon">⚠️</span>
        <span class="status-text">Bağlantı kuruluyor...</span>
    </div>

    <script src="script.js"></script>
    <script>
        // UUID Generation Function (simple version)
        function generateUUID() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // HayDay Chat System
        class HayDayChat {
            constructor() {
                this.clientId = this.getOrCreateClientId();
                this.isTyping = false;
                this.messageHistory = [];
                this.pollingInterval = null;
                this.lastPollTimestamp = Date.now();
                this.init();
            }

            getOrCreateClientId() {
                let clientId = localStorage.getItem('hd_client_id');
                if (!clientId) {
                    clientId = generateUUID();
                    localStorage.setItem('hd_client_id', clientId);
                }
                return clientId;
            }

            init() {
                this.setupEventListeners();
                this.loadHistory();
                this.focusInput();
                this.startPolling();
            }

            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');
                const searchBtn = document.getElementById('searchBtn');
                const closeBtn = document.getElementById('closeBtn');

                // Send message
                sendButton.addEventListener('click', () => this.sendMessage());
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Input validation
                messageInput.addEventListener('input', () => {
                    const text = messageInput.value.trim();
                    const charCount = document.getElementById('charCount');
                    
                    sendButton.disabled = text.length === 0;
                    charCount.textContent = `${text.length}/1000`;
                    
                    // Auto-resize textarea
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                });

                // Search functionality
                searchBtn.addEventListener('click', () => this.toggleSearch());

                // Close button
                closeBtn.addEventListener('click', () => {
                    if (window.opener) {
                        window.close();
                    } else {
                        window.history.back();
                    }
                });
            }

            async loadHistory() {
                try {
                    const response = await fetch(`/api/chat/history/${this.clientId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.history && data.history.length > 0) {
                            this.messageHistory = data.history;
                            this.renderHistory();
                        }
                    }
                } catch (error) {
                    console.error('Failed to load history:', error);
                }
            }

            renderHistory() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                this.messageHistory.forEach(msg => {
                    this.addMessageToDOM(msg.content, msg.role, msg.timestamp);
                });

                this.scrollToBottom();
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) return;

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                document.getElementById('charCount').textContent = '0/1000';
                document.getElementById('sendButton').disabled = true;

                // Add user message to DOM
                this.addMessageToDOM(message, 'user', Date.now());

                // Show typing indicator
                this.showTyping('chatbot');

                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            clientId: this.clientId,
                            message: message
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (data.role === 'ai') {
                            this.updateTypingRole('ai');
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        this.hideTyping();
                        this.addMessageToDOM(data.reply, data.role, data.timestamp);
                    } else {
                        this.hideTyping();
                        this.addMessageToDOM(data.error || 'Bir hata oluştu', 'system', Date.now());
                    }
                } catch (error) {
                    this.hideTyping();
                    this.addMessageToDOM('Bağlantı hatası. Lütfen tekrar deneyin.', 'system', Date.now());
                    console.error('Send message error:', error);
                }

                this.focusInput();
            }

            addMessageToDOM(content, role, timestamp) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageTime = new Date(timestamp).toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const roleConfig = {
                    user: { avatar: '👤', name: 'Siz', badge: 'KULLANICI', class: 'user' },
                    chatbot: { avatar: '🤖', name: 'HayDay Bot', badge: 'BOT', class: 'bot' },
                    ai: { avatar: '🧠', name: 'Yapay Zeka', badge: 'AI', class: 'ai' },
                    admin: { avatar: '👨‍💼', name: 'Destek Uzmanı', badge: 'UZMAN', class: 'admin' },
                    system: { avatar: '⚠️', name: 'Sistem', badge: 'SİSTEM', class: 'system' }
                };

                const config = roleConfig[role] || roleConfig.system;

                const messageElement = document.createElement('div');
                messageElement.className = `message message-${config.class}`;
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar">${config.avatar}</div>
                        <div class="message-info">
                            <span class="message-sender">${config.name}</span>
                            <span class="message-badge badge-${config.class}">${config.badge}</span>
                        </div>
                        <span class="message-time">${messageTime}</span>
                    </div>
                    <div class="message-content">${this.formatMessage(content)}</div>
                `;

                messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
            }

            formatMessage(content) {
                // Convert URLs to links
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                content = content.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
                
                // Convert line breaks
                content = content.replace(/\n/g, '<br>');
                
                return content;
            }

            showTyping(role) {
                const typingIndicator = document.getElementById('typingIndicator');
                const typingRole = document.getElementById('typingRole');
                
                const roleNames = {
                    chatbot: 'HayDay Bot',
                    ai: 'Yapay Zeka',
                    admin: 'Destek Uzmanı'
                };

                typingRole.textContent = roleNames[role] || 'HayDay Bot';
                typingIndicator.style.display = 'flex';
                this.scrollToBottom();
            }

            updateTypingRole(role) {
                const typingRole = document.getElementById('typingRole');
                const roleNames = {
                    chatbot: 'HayDay Bot',
                    ai: 'Yapay Zeka',
                    admin: 'Destek Uzmanı'
                };
                typingRole.textContent = roleNames[role] || 'HayDay Bot';
            }

            hideTyping() {
                document.getElementById('typingIndicator').style.display = 'none';
            }

            toggleSearch() {
                const searchContainer = document.getElementById('chatSearch');
                const searchInput = document.getElementById('searchInput');
                
                if (searchContainer.style.display === 'none') {
                    searchContainer.style.display = 'flex';
                    searchInput.focus();
                } else {
                    searchInput.value = '';
                    searchContainer.style.display = 'none';
                    document.querySelectorAll('.message').forEach(msg => {
                        msg.style.display = 'block';
                    });
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }

            focusInput() {
                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 100);
            }

            startPolling() {
                this.pollingInterval = setInterval(() => {
                    this.pollForNewMessages();
                }, 5000);
            }

            stopPolling() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                    this.pollingInterval = null;
                }
            }

            async pollForNewMessages() {
                try {
                    const response = await fetch(`/api/chat/poll/${this.clientId}?after=${this.lastPollTimestamp}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.newMessages && data.newMessages.length > 0) {
                            data.newMessages.forEach(message => {
                                if (message.role !== 'user' || message.timestamp <= this.lastPollTimestamp) {
                                    this.addMessageToDOM(message.content, message.role, message.timestamp);
                                }
                            });
                            
                            this.lastPollTimestamp = data.lastTimestamp;
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }

            beforeUnload() {
                this.stopPolling();
            }
        }

        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const chat = new HayDayChat();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                chat.beforeUnload();
            });
        });
    </script>
</body>
</html>
