<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HayDay Destek Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-header-content">
                <div class="chat-title">
                    <span class="chat-avatar">🌾</span>
                    <div>
                        <h3>HayDay Destek</h3>
                        <span class="chat-status online" id="connectionStatus">Çevrimiçi</span>
                    </div>
                </div>
                
                <div class="chat-actions">
                    <button class="action-btn" id="searchBtn" title="Ara">🔍</button>
                    <button class="action-btn" id="closeBtn" title="Kapat">✕</button>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="search-container" id="searchContainer" style="display: none;">
                <input type="text" id="searchInput" placeholder="Mesajlarda ara..." class="search-input">
                <button class="search-clear-btn" id="searchClear">✕</button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" data-message="Altın transfer nasıl yapılır?">
                🏆 Altın Transfer
            </button>
            <button class="quick-action-btn" data-message="Fiyat listesi göster">
                💸 Fiyat Listesi
            </button>
            <button class="quick-action-btn" data-message="Depolama hesaplama">
                📦 Depolama
            </button>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="chat-welcome" id="welcomeMessage">
                <div class="welcome-avatar">🌾</div>
                <h4>HayDay Destek'e Hoş Geldiniz!</h4>
                <p>Size nasıl yardımcı olabilirim? HayDay oyunu ve sitemizdeki hizmetler hakkında sorularınızı sorabilirsiniz.</p>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-avatar">🤖</div>
            <div class="typing-text">
                HayDay Bot yazıyor...
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Mesajınızı yazın..." 
                    rows="1" 
                    maxlength="1000"
                ></textarea>
                
                <button class="send-button" id="sendButton" disabled>
                    <span class="send-icon">→</span>
                </button>
            </div>

            <div class="chat-input-footer">
                <span class="powered-by">HayDay Malzemeleri tarafından desteklenmektedir</span>
                <span class="char-count" id="charCount">0/1000</span>
            </div>
        </div>
    </div>

    <!-- Footer Actions -->
    <div class="chat-footer-actions">
        <a href="login.html" class="footer-link" id="adminLink">
            👑👑👑 Admin
        </a>
    </div>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script>
        // HayDay Chat Class
        class HayDayChat {
            constructor() {
                this.clientId = this.generateClientId();
                this.messageQueue = [];
                this.isProcessing = false;
                this.lastMessageTimestamp = 0;
                this.pollInterval = null;
                
                this.initializeChat();
                this.bindEvents();
                this.startPolling();
            }

            generateClientId() {
                return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            initializeChat() {
                console.log('🌾 HayDay Chat başlatılıyor...');
                this.showConnectionStatus('online');
                
                // Show quick actions initially
                document.getElementById('quickActions').classList.add('show');
            }

            bindEvents() {
                const elements = {
                    sendButton: document.getElementById('sendButton'),
                    messageInput: document.getElementById('messageInput'),
                    searchBtn: document.getElementById('searchBtn'),
                    closeBtn: document.getElementById('closeBtn'),
                    searchInput: document.getElementById('searchInput'),
                    searchClear: document.getElementById('searchClear'),
                    charCount: document.getElementById('charCount')
                };

                // Send message
                elements.sendButton.addEventListener('click', () => this.sendMessage());
                
                // Enter to send
                elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Input handling
                elements.messageInput.addEventListener('input', (e) => {
                    this.handleInputChange(e.target.value);
                });

                // Search functionality
                elements.searchBtn.addEventListener('click', () => this.toggleSearch());
                elements.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                elements.searchClear.addEventListener('click', () => this.clearSearch());

                // Quick action buttons
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const message = e.target.getAttribute('data-message');
                        document.getElementById('messageInput').value = message;
                        this.handleInputChange(message);
                        this.sendMessage();
                    });
                });

                // Close chat
                elements.closeBtn.addEventListener('click', () => {
                    document.getElementById('chatContainer').style.display = 'none';
                });
            }

            handleInputChange(value) {
                const sendButton = document.getElementById('sendButton');
                const charCount = document.getElementById('charCount');
                
                sendButton.disabled = !value.trim();
                charCount.textContent = `${value.length}/1000`;
                
                // Auto-resize textarea
                const textarea = document.getElementById('messageInput');
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message || this.isProcessing) return;
                
                this.isProcessing = true;
                input.value = '';
                this.handleInputChange('');
                
                // Add user message immediately
                this.addMessage({
                    role: 'user',
                    content: message,
                    timestamp: Date.now(),
                    clientId: this.clientId
                });
                
                // Show typing indicator
                this.showTyping();
                
                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            clientId: this.clientId
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Hide typing indicator
                    this.hideTyping();
                    
                    // Add bot response
                    if (data.response) {
                        this.addMessage({
                            role: 'assistant',
                            content: data.response,
                            timestamp: Date.now(),
                            clientId: this.clientId,
                            source: data.source || 'chatbot'
                        });
                    }
                    
                    this.showConnectionStatus('online');
                    
                } catch (error) {
                    console.error('Send message error:', error);
                    this.hideTyping();
                    
                    this.addMessage({
                        role: 'assistant',
                        content: 'Üzgünüm, bir hata oluştu. Lütfen Sorular & İletişim sayfamızdan bize ulaşın.',
                        timestamp: Date.now(),
                        clientId: this.clientId
                    });

                    this.showConnectionStatus('error');
                }
                
                this.isProcessing = false;
            }

            addMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                // Hide welcome message
                if (welcomeMessage) {
                    welcomeMessage.style.display = 'none';
                }

                // Hide quick actions after first message
                document.getElementById('quickActions').classList.remove('show');

                // Create message element
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${message.role}`;
                messageEl.dataset.timestamp = message.timestamp;

                const avatar = this.getRoleAvatar(message.role);
                const badge = this.getRoleBadge(message.role);
                const time = HayDayChat.Utils.formatTime(message.timestamp);

                messageEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar" style="background: ${this.getRoleColor(message.role)}">
                            ${avatar}
                        </div>
                        <div class="message-info">
                            <span class="message-role">${badge}</span>
                            <span class="message-time">${time}</span>
                        </div>
                    </div>
                    <div class="message-content">${this.formatMessageContent(message.content)}</div>
                `;

                messagesContainer.appendChild(messageEl);
                this.scrollToBottom();
            }

            getRoleAvatar(role) {
                const avatars = {
                    'user': '👤',
                    'assistant': '🤖',
                    'admin': '👑'
                };
                return avatars[role] || '❓';
            }

            getRoleBadge(role) {
                const badges = {
                    'user': 'Siz',
                    'assistant': 'HayDay Bot',
                    'admin': 'Admin'
                };
                return badges[role] || 'Bilinmeyen';
            }

            getRoleColor(role) {
                const colors = {
                    'user': '#007bff',
                    'assistant': '#28a745',
                    'admin': '#ffc107'
                };
                return colors[role] || '#6c757d';
            }

            formatMessageContent(content) {
                return content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>');
            }

            showTyping() {
                document.getElementById('typingIndicator').style.display = 'block';
                this.scrollToBottom();
            }

            hideTyping() {
                document.getElementById('typingIndicator').style.display = 'none';
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }

            showConnectionStatus(status) {
                const statusEl = document.getElementById('connectionStatus');
                const statusTexts = {
                    'online': 'Çevrimiçi',
                    'connecting': 'Bağlanıyor...',
                    'error': 'Bağlantı Hatası'
                };
                
                statusEl.textContent = statusTexts[status] || status;
                statusEl.className = `chat-status ${status}`;
            }

            startPolling() {
                this.pollInterval = setInterval(() => {
                    this.checkForNewMessages();
                }, 3000); // Poll every 3 seconds
            }

            async checkForNewMessages() {
                try {
                    const response = await fetch(`/api/chat/poll/${this.clientId}?after=${this.lastMessageTimestamp}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.newMessages && data.newMessages.length > 0) {
                            data.newMessages.forEach(message => {
                                if (message.role !== 'user') { // Don't duplicate user messages
                                    this.addMessage(message);
                                }
                            });
                            
                            this.lastMessageTimestamp = data.lastTimestamp;
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }

            toggleSearch() {
                const searchContainer = document.getElementById('searchContainer');
                const searchInput = document.getElementById('searchInput');
                
                if (searchContainer.style.display === 'none') {
                    searchContainer.style.display = 'block';
                    searchInput.focus();
                } else {
                    searchContainer.style.display = 'none';
                    this.clearSearch();
                }
            }

            handleSearch(query) {
                const messages = document.querySelectorAll('.message');
                
                messages.forEach(messageEl => {
                    const content = messageEl.querySelector('.message-content').textContent;
                    const isMatch = !query || HayDayChat.Search.fuzzyMatch(content, query);
                    
                    if (isMatch) {
                        messageEl.style.display = 'block';
                        if (query) {
                            const contentEl = messageEl.querySelector('.message-content');
                            contentEl.innerHTML = HayDayChat.Search.highlight(contentEl.textContent, query);
                        }
                    } else {
                        messageEl.style.display = 'none';
                    }
                });
            }

            clearSearch() {
                const searchInput = document.getElementById('searchInput');
                searchInput.value = '';
                this.handleSearch('');
            }
        }

        // Utility functions
        HayDayChat.Utils = {
            formatTime: (timestamp) => {
                return new Date(timestamp).toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        };

        // Search functions
        HayDayChat.Search = {
            fuzzyMatch: (text, query) => {
                return text.toLowerCase().includes(query.toLowerCase());
            },
            
            highlight: (text, query) => {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            }
        };

        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.haydayChat = new HayDayChat();
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (window.haydayChat && window.haydayChat.pollInterval) {
                clearInterval(window.haydayChat.pollInterval);
            }
        });
    </script>
</body>
</html>
