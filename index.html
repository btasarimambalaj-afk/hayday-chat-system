<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HayDay Destek Chat - Premium Deneyim</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="HayDay oyun destek sistemi - Altın transfer, fiyat listesi, depolama hesaplama">
    <meta name="keywords" content="hayday, oyun, destek, chat, bot">
</head>
<body>
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">
                    🌾
                </div>
                <div class="chat-title">
                    <h3>HayDay Destek</h3>
                    <p class="chat-status" id="chatStatus">
                        <span class="status-indicator online"></span>
                        Çevrimiçi
                    </p>
                </div>
            </div>

            <div class="chat-header-actions">
                <button class="action-btn" id="searchBtn" title="Mesajlarda Ara">
                    <span>🔍</span>
                </button>
                <button class="action-btn" id="closeBtn" title="Kapat">
                    <span>✕</span>
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container" id="searchContainer" style="display: none;">
            <div class="search-input-wrapper">
                <input type="text" id="searchInput" placeholder="Mesajlarda ara..." maxlength="100">
                <button class="search-clear" id="searchClear" title="Temizle">✕</button>
            </div>
        </div>

        <!-- Chat Content -->
        <div class="chat-content">
            <!-- Quick Actions -->
            <div class="quick-actions" id="quickActions">
                <button class="quick-action-btn" data-message="Altın transfer nasıl yapılır?">
                    💰 Altın Transfer
                </button>
                <button class="quick-action-btn" data-message="Fiyat listesi">
                    💸 Fiyat Listesi
                </button>
                <button class="quick-action-btn" data-message="Depolama hesaplama">
                    📦 Depolama
                </button>
            </div>

            <!-- Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Message -->
                <div class="chat-welcome" id="welcomeMessage">
                    <div class="welcome-avatar">
                        🌾
                    </div>
                    <h4>HayDay Destek'e Hoş Geldiniz!</h4>
                    <p>Size nasıl yardımcı olabilirim? HayDay oyunu ve sitemizdeki hizmetler hakkında sorularınızı sorabilirsiniz.</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="typing-avatar">
                    🤖
                </div>
                <div class="typing-text">
                    HayDay Bot yazıyor...
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Mesajınızı yazın..." 
                    rows="1" 
                    maxlength="1000"
                ></textarea>
                
                <button class="send-button" id="sendButton" disabled>
                    <span class="send-icon">→</span>
                </button>
            </div>

            <div class="chat-input-footer">
                <span class="powered-by">HayDay Malzemeleri tarafından desteklenmektedir</span>
                <span class="char-count" id="charCount">0/1000</span>
            </div>
        </div>
    </div>

    <!-- Footer Actions -->
    <div class="chat-footer-actions">
        <a href="login.html" class="footer-link" id="adminLink">
            👑👑👑
            Admin
        </a>
    </div>

    <!-- Chat System Script -->
    <script src="script.js"></script>
    <script>
        class HayDayChat {
            constructor() {
                this.clientId = this.generateClientId();
                this.lastTimestamp = 0;
                this.pollInterval = null;
                this.isPolling = false;
                this.connectionStatus = 'connecting';
                
                this.init();
            }

            generateClientId() {
                return 'client_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }

            init() {
                this.bindEvents();
                this.startPolling();
                this.showConnectionStatus('connecting');
                
                // Show quick actions initially
                document.getElementById('quickActions').classList.add('show');
            }

            bindEvents() {
                const elements = {
                    sendButton: document.getElementById('sendButton'),
                    messageInput: document.getElementById('messageInput'),
                    searchBtn: document.getElementById('searchBtn'),
                    closeBtn: document.getElementById('closeBtn'),
                    searchInput: document.getElementById('searchInput'),
                    searchClear: document.getElementById('searchClear'),
                    charCount: document.getElementById('charCount')
                };

                // Send message
                elements.sendButton.addEventListener('click', () => this.sendMessage());
                
                // Enter to send
                elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Input handling
                elements.messageInput.addEventListener('input', (e) => {
                    this.handleInputChange(e.target.value);
                });

                // Search functionality
                elements.searchBtn.addEventListener('click', () => this.toggleSearch());
                elements.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                elements.searchClear.addEventListener('click', () => this.clearSearch());

                // Quick actions
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('quick-action-btn')) {
                        const message = e.target.getAttribute('data-message');
                        elements.messageInput.value = message;
                        this.handleInputChange(message);
                        this.sendMessage();
                    }
                });

                // Close chat
                elements.closeBtn.addEventListener('click', () => {
                    document.getElementById('chatContainer').style.display = 'none';
                });
            }

            handleInputChange(value) {
                const sendButton = document.getElementById('sendButton');
                const charCount = document.getElementById('charCount');
                
                sendButton.disabled = value.trim().length === 0;
                charCount.textContent = `${value.length}/1000`;
                
                // Auto-resize textarea
                const textarea = document.getElementById('messageInput');
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) return;

                // Add user message immediately
                this.addMessage({
                    role: 'user',
                    content: message,
                    timestamp: Date.now(),
                    clientId: this.clientId
                });

                // Clear input
                messageInput.value = '';
                this.handleInputChange('');

                // Show typing indicator
                this.showTypingIndicator(true);

                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            clientId: this.clientId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Hide typing indicator
                    this.showTypingIndicator(false);
                    
                    // Add bot response
                    if (data.response) {
                        this.addMessage({
                            role: 'assistant',
                            content: data.response,
                            timestamp: Date.now(),
                            clientId: this.clientId
                        });
                        
                        this.showConnectionStatus('connected');
                    }

                } catch (error) {
                    console.error('Send message error:', error);
                    this.showTypingIndicator(false);
                    
                    // Add error message
                    this.addMessage({
                        role: 'assistant',
                        content: 'Üzgünüm, bir hata oluştu. Lütfen Sorular & İletişim sayfamızdan bize ulaşın.'
                    });

                    this.showConnectionStatus('error');
                }
            }

            addMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                // Hide welcome message
                if (welcomeMessage) {
                    welcomeMessage.style.display = 'none';
                }

                // Hide quick actions after first message
                document.getElementById('quickActions').classList.remove('show');

                // Create message element
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${message.role}`;
                messageEl.dataset.timestamp = message.timestamp;

                const avatar = this.getRoleAvatar(message.role);
                const badge = this.getRoleBadge(message.role);
                const time = HayDayChat.Utils.formatTime(message.timestamp);

                messageEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar" style="background: ${this.getRoleColor(message.role)}">
                            ${avatar}
                        </div>
                        <div class="message-info">
                            <span class="message-sender">${badge}</span>
                            <span class="message-time">${time}</span>
                        </div>
                    </div>
                    <div class="message-content">${this.formatMessageContent(message.content)}</div>
                `;

                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Update last timestamp
                if (message.timestamp) {
                    this.lastTimestamp = Math.max(this.lastTimestamp, message.timestamp);
                }
            }

            getRoleAvatar(role) {
                const avatars = {
                    'user': '👤',
                    'assistant': '🤖',
                    'system': '⚙️'
                };
                return avatars[role] || '💬';
            }

            getRoleBadge(role) {
                const badges = {
                    'user': 'Siz',
                    'assistant': 'HayDay Bot',
                    'system': 'Sistem'
                };
                return badges[role] || 'Bilinmeyen';
            }

            getRoleColor(role) {
                const colors = {
                    'user': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'assistant': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'system': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
                };
                return colors[role] || '#ccc';
            }

            formatMessageContent(content) {
                if (!content) return '';
                
                // Convert URLs to links
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                content = content.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
                
                // Convert line breaks
                content = content.replace(/\n/g, '<br>');
                
                return content;
            }

            showTypingIndicator(show) {
                const indicator = document.getElementById('typingIndicator');
                const messagesContainer = document.getElementById('chatMessages');
                
                indicator.style.display = show ? 'flex' : 'none';
                
                if (show) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            showConnectionStatus(status) {
                const statusEl = document.querySelector('.chat-status');
                const indicator = document.querySelector('.status-indicator');
                
                this.connectionStatus = status;
                
                const statusConfig = {
                    'connecting': { text: 'Bağlanıyor...', class: 'connecting' },
                    'connected': { text: 'Çevrimiçi', class: 'online' },
                    'error': { text: 'Bağlantı Hatası', class: 'offline' },
                    'offline': { text: 'Çevrimdışı', class: 'offline' }
                };
                
                const config = statusConfig[status] || statusConfig.offline;
                statusEl.innerHTML = `<span class="status-indicator ${config.class}"></span>${config.text}`;
            }

            startPolling() {
                if (this.isPolling) return;
                
                this.isPolling = true;
                this.pollInterval = setInterval(() => {
                    this.pollForNewMessages();
                }, 2000); // Poll every 2 seconds
            }

            stopPolling() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
                this.isPolling = false;
            }

            async pollForNewMessages() {
                try {
                    const response = await fetch(`/api/chat/poll/${this.clientId}?after=${this.lastTimestamp}`);
                    
                    if (!response.ok) {
                        throw new Error(`Poll failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.newMessages && data.newMessages.length > 0) {
                        data.newMessages.forEach(message => {
                            if (message.role !== 'user') { // Don't show our own messages
                                this.addMessage(message);
                            }
                        });
                    }
                    
                    if (data.lastTimestamp) {
                        this.lastTimestamp = data.lastTimestamp;
                    }
                    
                    // Update connection status
                    if (this.connectionStatus !== 'connected') {
                        this.showConnectionStatus('connected');
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    this.showConnectionStatus('error');
                }
            }

            toggleSearch() {
                const searchContainer = document.getElementById('searchContainer');
                const searchInput = document.getElementById('searchInput');
                
                if (searchContainer.style.display === 'none') {
                    searchContainer.style.display = 'block';
                    searchInput.focus();
                } else {
                    searchContainer.style.display = 'none';
                    this.clearSearch();
                }
            }

            handleSearch(query) {
                const messages = document.querySelectorAll('.message');
                
                messages.forEach(messageEl => {
                    const content = messageEl.querySelector('.message-content').textContent;
                    const isMatch = !query || HayDayChat.Search.fuzzyMatch(content, query);
                    
                    if (isMatch) {
                        messageEl.style.display = 'block';
                        if (query) {
                            const contentEl = messageEl.querySelector('.message-content');
                            contentEl.innerHTML = HayDayChat.Search.highlight(contentEl.textContent, query);
                        }
                    } else {
                        messageEl.style.display = 'none';
                    }
                });
            }

            clearSearch() {
                const searchInput = document.getElementById('searchInput');
                searchInput.value = '';
                this.handleSearch('');
            }
        }

        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.haydayChat = new HayDayChat();
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (window.haydayChat && window.haydayChat.pollInterval) {
                clearInterval(window.haydayChat.pollInterval);
            }
        });
    </script>
</body>
</html>
